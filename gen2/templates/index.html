<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ASCII Video Generator</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        
    
    <style>


        body {
            background-color: black;
            color: rgb(152, 255, 248);
            font-family: monospace;
            text-align: center;
            padding: 20px;
            margin: 0;
        }
        .ascii-container {
            width: 100%;
            max-width: 1000px;
            height: 50vh;
            margin: 20px auto;
            overflow: hidden;
            border: 1px solid rgb(219, 255, 140);
            padding: 10px;
            box-sizing: border-box;
        }
        #ascii-display {
            font-size: 8px;
            line-height: 0.7;
            white-space: pre;
            font-family: monospace;
            padding-top: 25px;
        }
        .hidden {
            display: none;
        }
        .error {
            color: #ff4444;
            margin: 10px 0;
        }
        #uploadForm {
            margin: 20px 0;
        }
        #fileName {
            margin: 10px 0;
            color: rgb(215, 215, 64);
            padding: 5px 10px;
            border: 1px solid rgb(97, 246, 218);
            border-radius: 4px;
            display: inline-block;
        }
        .color-picker-container {
            display: inline-block;
            position: relative;
            vertical-align: middle;
            border: 1px solid rgb(249, 249, 249);
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .color-picker-container:hover {
            background-color: rgba(208, 255, 0, 0.1);
            transform: scale(1.02);
        }
        .color-picker-icon {
            color: rgb(208, 255, 0);
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .color-picker-icon:hover {
            transform: scale(1.1);
        }
        .color-picker-icon {
            color: rgb(255, 255, 255);
            font-size: 20px;
            cursor: pointer;
        }
        #colorPicker {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        button {
            background-color: rgb(255, 255, 255);
            color: black;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background-color: rgb(255, 255, 255);
        }
        .fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 95vw;
        height: 95vh;
        background: black;
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .fullscreen #ascii-display {
        font-size: 12px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding-bottom: 20px;
    }

    
        
        .control-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
        }
        .control-panel.hidden {
            display: none;
        }
        #fullscreenColorPicker {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>ASCII Video Generator</h1>
    
    <form id="uploadForm" enctype="multipart/form-data">
        <div id="fileInputContainer">
            <input type="file" name="file" id="fileInput" accept="video/*">
            <p id="fileName">No file selected</p>
        </div>
        <div>
            <label for="colorPicker">Choose ASCII Color: </label>
            <div class="color-picker-container">
                <label for="colorPicker">
                    <i class="fas fa-palette color-picker-icon"></i>
                </label>
                <input type="color" id="colorPicker" value="#d0ff00">
            </div>
        </div>
        <button type="submit" id="uploadButton">Upload and Generate</button>
        <button type="button" id="fullscreenButton" class="hidden">
            <i class="fas fa-expand"></i> Fullscreen
        </button>
        
    </form>

    <div id="error" class="error hidden"></div>
    <div id="loading" class="hidden">Processing video...</div>
    
    <div class="ascii-container">
        <div id="ascii-display"></div>
    </div>

    <div id="controlPanel" class="control-panel hidden">
        <button id="exitFullscreen">
            <i class="fas fa-compress"></i>
        </button>
        <div class="color-picker-container">
            <label for="fullscreenColorPicker">
                <i class="fas fa-palette color-picker-icon"></i>
            </label>
            <input type="color" id="fullscreenColorPicker">
        </div>
    </div>

    <script>
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const fileContainer = document.getElementById('fileInputContainer');
        const errorDiv = document.getElementById('error');
        const loadingDiv = document.getElementById('loading');
        const fileName = document.getElementById('fileName');
        const colorPicker = document.getElementById('colorPicker');
        const fullscreenColorPicker = document.getElementById('fullscreenColorPicker');
        const asciiDisplay = document.getElementById('ascii-display');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const controlPanel = document.getElementById('controlPanel');
        const container = document.querySelector('.ascii-container');

        let frames = [];
        let currentFrame = 0;
        let isPlaying = false;
        let playbackInterval = null;
        let isFullscreen = false;

        fileInput.addEventListener('change', e => {
            fileName.textContent = e.target.files[0]?.name || 'No file selected';
        });

        function updateColors(newColor) {
            document.body.style.color = newColor;
            asciiDisplay.style.color = newColor;
            document.querySelectorAll('.color-picker-container, .ascii-container').forEach(el => {
                el.style.borderColor = newColor;
            });
            document.querySelectorAll('.color-picker-icon').forEach(el => {
                el.style.color = newColor;
            });
            colorPicker.value = newColor;
            fullscreenColorPicker.value = newColor;
        }

        colorPicker.addEventListener('input', e => {
            updateColors(e.target.value);
        });

        fullscreenColorPicker.addEventListener('input', e => {
            updateColors(e.target.value);
        });

        fullscreenButton.addEventListener('click', () => {
            isFullscreen = true;
            container.classList.add('fullscreen');
            controlPanel.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            adjustAsciiContainer();
        });

        document.getElementById('exitFullscreen').addEventListener('click', () => {
            isFullscreen = false;
            container.classList.remove('fullscreen');
            controlPanel.classList.add('hidden');
            document.body.style.overflow = '';
            adjustAsciiContainer();
        });

        
        form.addEventListener('submit', async e => {
            e.preventDefault();
            if (uploadButton.textContent === 'Upload New') {
                stopPlayback();
                fileContainer.classList.remove('hidden');
                uploadButton.textContent = 'Upload and Generate';
                fileInput.value = '';
                fileName.textContent = 'No file selected';
                asciiDisplay.textContent = '';
                fullscreenButton.classList.add('hidden');
              
                return;
            }

            const file = fileInput.files[0];
            if (!file) return;

            fileContainer.classList.add('hidden');
            uploadButton.textContent = 'Upload New';
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                loadingDiv.classList.add('hidden');
                asciiDisplay.textContent = '';
                frames = [];
                currentFrame = 0;
                await fetchFrames();
                startPlayback();
                fullscreenButton.classList.remove('hidden');
               
            } catch (error) {
                showError(error.message);
            }
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            loadingDiv.classList.add('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        async function fetchFrames() {
            try {
                const response = await fetch('/stream');
                if (!response.ok) throw new Error('Failed to fetch frames');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, {stream: true});
                    const newFrames = buffer.split('<!--frame-separator-->');
                    buffer = newFrames.pop();

                    frames.push(...newFrames.filter(frame => frame.trim()));
                }
            } catch (error) {
                showError(error.message);
            }
        }

        function startPlayback() {
            if (!frames.length || isPlaying) return;
            isPlaying = true;
            playbackInterval = setInterval(() => {
                displayFrame(frames[currentFrame]);
                currentFrame = (currentFrame + 1) % frames.length;
            }, 1000 / 30);
        }

        function stopPlayback() {
            isPlaying = false;
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
            }
        }

        function displayFrame(frame) {
            asciiDisplay.textContent = frame;
            adjustAsciiContainer();
        }

        function adjustAsciiContainer() {
            const containerWidth = isFullscreen ? window.innerWidth : container.clientWidth;
            const containerHeight = isFullscreen ? window.innerHeight : container.clientHeight;
            
            
            const lines = asciiDisplay.textContent.split('\n');
            const width = Math.max(...lines.map(line => line.length));
            const height = lines.length;
            
            const fontWidth = containerWidth / width;
            const fontHeight = containerHeight / height;
            const fontSize = Math.min(fontWidth, fontHeight) * 0.8;
            
            asciiDisplay.style.fontSize = `${fontSize}px`;
            asciiDisplay.style.lineHeight = '1';
        }

        window.addEventListener('resize', adjustAsciiContainer);
    </script>
</body>
</html>